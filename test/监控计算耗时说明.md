# 服务端监控中计算耗时的处理情况

## 问题

**在统计服务端时，有没有要求收到计算耗时的变化？**

## 当前情况分析

### 1. 监控快照结构（MonitoringSnapshot）

监控快照**只包含资源使用情况**，不包含计算耗时：

```protobuf
message MonitoringSnapshot {
    double timestamp = 1;          // 时间戳
    float cpu_percent = 2;         // CPU 使用率
    float memory_mb = 3;           // 内存使用 (MB)
    float memory_percent = 4;      // 内存使用率
    bool gpu_available = 5;        // GPU 是否可用
    optional float gpu_utilization = 6;  // GPU 使用率
    optional float gpu_memory_used_mb = 7;
    optional float gpu_memory_total_mb = 8;
    // ❌ 没有 compute_time_ms 字段
}
```

### 2. 计算耗时单独返回

计算耗时在 `ComputeResponse` 中作为**独立字段**返回：

```protobuf
message ComputeResponse {
    bytes data = 1;
    repeated int32 shape = 2;
    optional int32 request_id = 3;
    optional float compute_time_ms = 4;        // ✅ 计算耗时单独返回
    optional MonitoringSnapshot monitoring_data = 5;  // 监控快照（不包含耗时）
}
```

### 3. 客户端收集数据的情况

客户端在收集监控快照时，**只收集资源信息**，没有将计算耗时关联到快照：

```python
# SplitLearnComm/src/splitlearn_comm/client/grpc_client.py
if response.HasField("monitoring_data"):
    monitoring_data = response.monitoring_data
    snapshot_dict = {
        "timestamp": monitoring_data.timestamp,
        "cpu_percent": monitoring_data.cpu_percent,
        "memory_mb": monitoring_data.memory_mb,
        # ... 其他资源信息
        # ❌ 没有包含 compute_time_ms
    }
    self.server_monitoring_snapshots.append(snapshot_dict)

# compute_time_ms 被单独累加，但未关联到快照
self.total_compute_time += response.compute_time_ms
```

## 结论

### ✅ 回答您的问题

**在统计服务端时，目前没有要求收到计算耗时的变化。**

原因：
1. **监控快照不包含计算耗时**：`MonitoringSnapshot` 只包含资源使用情况
2. **计算耗时单独处理**：`compute_time_ms` 在响应中单独返回，客户端单独累加统计
3. **监控快照和计算耗时分离**：两者没有关联，无法追踪计算耗时的时序变化

### 当前能看到的统计

1. **资源使用变化**（通过监控快照）：
   - CPU 使用率的时间序列
   - 内存使用的时间序列
   - GPU 使用率的时间序列

2. **计算耗时统计**（通过单独累加）：
   - 平均计算耗时
   - 总计算耗时
   - **但看不到每次请求的计算耗时变化趋势**

## 如果需要追踪计算耗时变化

如果需要追踪计算耗时的变化（例如绘制计算耗时的时间序列图），需要修改代码：

### 方案 1：在客户端收集时将计算耗时加入快照

修改 `SplitLearnComm/src/splitlearn_comm/client/grpc_client.py`：

```python
# 5. 接收并存储服务端监控数据
if response.HasField("monitoring_data"):
    monitoring_data = response.monitoring_data
    snapshot_dict = {
        "timestamp": monitoring_data.timestamp,
        "cpu_percent": monitoring_data.cpu_percent,
        "memory_mb": monitoring_data.memory_mb,
        "memory_percent": monitoring_data.memory_percent,
        "gpu_available": monitoring_data.gpu_available,
        # ... 其他字段
        
        # ✅ 添加计算耗时到快照
        "compute_time_ms": response.compute_time_ms if response.HasField("compute_time_ms") else None,
    }
    self.server_monitoring_snapshots.append(snapshot_dict)
```

### 方案 2：在 protobuf 中扩展 MonitoringSnapshot

修改 `compute_service.proto`，在 `MonitoringSnapshot` 中添加计算耗时字段：

```protobuf
message MonitoringSnapshot {
    // ... 现有字段
    optional float compute_time_ms = 9;  // 本次请求的计算耗时
}
```

然后在服务器端返回监控快照时，将计算耗时也包含进去。

## 总结

- **当前状态**：监控快照只包含资源使用情况，不包含计算耗时
- **计算耗时处理**：单独统计平均值，不追踪变化趋势
- **改进建议**：如果需要追踪计算耗时变化，需要修改代码将计算耗时关联到监控快照

