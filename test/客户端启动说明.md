# Split Learning 客户端启动和统计说明

## 快速启动

### 方式 1: 使用启动脚本（推荐）

```bash
cd /Users/lhy/Desktop/Git/SL
bash test/start_client_with_stats.sh 192.168.0.144:50052
```

或者使用默认服务器地址：
```bash
bash test/start_client_with_stats.sh
```

### 方式 2: 直接使用 Python 命令

```bash
cd /Users/lhy/Desktop/Git/SL
/Library/Frameworks/Python.framework/Versions/3.11/bin/python3 test/client/interactive_client.py 192.168.0.144:50052
```

### 方式 3: 使用环境变量

```bash
cd /Users/lhy/Desktop/Git/SL
export TRUNK_SERVER=192.168.0.144:50052
/Library/Frameworks/Python.framework/Versions/3.11/bin/python3 test/client/interactive_client.py
```

## 统计功能说明

客户端启动后会自动启用以下监控和统计功能：

### 1. 客户端资源监控

- ✅ **CPU 使用率**：实时监控客户端 CPU 使用情况
- ✅ **内存使用**：实时监控客户端内存使用情况
- ✅ **资源使用时间线**：生成资源使用的时序图表

### 2. 服务器资源监控（如果服务器支持）

- ✅ **服务器 CPU 使用率**：从服务器获取的 CPU 使用情况
- ✅ **服务器内存使用**：从服务器获取的内存使用情况
- ✅ **服务器 GPU 使用率**（如果可用）：GPU 使用情况
- ✅ **服务器资源时间线**：生成服务器资源使用的时序图表

### 3. 性能阶段统计

- ✅ **Bottom 模型处理时间**：本地 Bottom 模型执行时间
- ✅ **Trunk 远程调用时间**：网络传输 + 服务器计算时间
- ✅ **Top 模型处理时间**：本地 Top 模型执行时间
- ✅ **总生成时间**：完整的文本生成时间

### 4. 自动生成的报告

客户端退出时会自动生成以下报告：

#### 合并报告（如果服务器支持监控）
- 文件位置：`test/reports/interactive_client_YYYYMMDD_HHMMSS_merged_report.html`
- 包含内容：
  - 客户端资源监控图表
  - 服务器资源监控图表
  - 客户端 vs 服务器对比
  - 性能阶段统计
  - 详细时间分析

#### 客户端报告（如果服务器不支持监控）
- 文件位置：`test/reports/interactive_client_YYYYMMDD_HHMMSS_report.html`
- 包含内容：
  - 客户端资源监控图表
  - 性能阶段统计
  - 详细时间分析

#### JSON 数据报告
- 文件位置：`test/reports/interactive_client_YYYYMMDD_HHMMSS_report.json`
- 包含内容：所有监控数据的 JSON 格式（可用于后续分析）

## 使用示例

1. **启动客户端**：
   ```bash
   bash test/start_client_with_stats.sh 192.168.0.144:50052
   ```

2. **输入文本进行对话**：
   ```
   你: Hello, how are you?
   AI: I'm doing well, thank you for asking...
   
   [本次详细统计]
     总生成时间: 1234.5ms
     生成步骤数: 30
     ┌─ 本地处理:
     │  Bottom 模型: 30次, 总计 123.4ms, 平均 4.1ms/次
     │  Top 模型:    30次, 总计 234.5ms, 平均 7.8ms/次
     └─ 远程调用:
        总往返时间:  876.6ms, 平均 29.2ms/次
   ```

3. **退出程序**：
   ```
   你: quit
   ```

4. **查看统计报告**：
   程序退出后，会显示报告保存路径：
   ```
   [监控报告]
     ✓ 合并报告已保存（包含客户端+服务器统计）: test/reports/interactive_client_20251207_153022_merged_report.html
     JSON 数据已保存: test/reports/interactive_client_20251207_153022_report.json
   ```

## 监控统计包含的信息

### 控制台输出统计

程序运行过程中会显示：
- 每次请求的详细时间统计
- 本地处理时间（Bottom、Top 模型）
- 远程调用时间（网络传输 + 服务器计算）
- 生成 tokens 数量

### HTML 报告统计

报告文件包含：
- 📊 **资源使用时间线图表**（CPU、内存、GPU）
- 📈 **性能阶段对比图表**
- 📉 **阶段时间分布图表**
- 📋 **详细统计表格**（平均值、最大值、P95等）
- ⚖️ **客户端 vs 服务器对比**（如果是合并报告）

### JSON 报告数据

JSON 文件包含：
- 所有资源快照数据（时间戳、CPU、内存、GPU）
- 所有性能阶段数据（阶段名称、耗时、调用次数）
- 完整的统计摘要

## 注意事项

1. **服务器监控数据**：
   - 只有在服务器启用 `ServerMonitor` 时才能获取服务器统计
   - 如果服务器不支持监控，只会生成客户端报告

2. **报告生成位置**：
   - 所有报告保存在 `test/reports/` 目录
   - 文件名包含时间戳，方便区分不同会话

3. **监控开销**：
   - 监控功能的 CPU 开销 < 5%
   - 内存开销 < 50MB

## 故障排除

### 问题 1: 无法连接到服务器

```
❌ 连接失败: StatusCode.UNAVAILABLE
```

**解决方案**：
- 检查服务器是否正在运行
- 检查 IP 地址和端口是否正确
- 检查网络连接

### 问题 2: 监控报告未生成

**解决方案**：
- 确保程序正常退出（输入 `quit` 或 `exit`）
- 检查 `test/reports/` 目录是否存在写入权限
- 查看控制台是否有错误信息

### 问题 3: 只有客户端统计，没有服务器统计

**原因**：服务器未启用监控或监控数据不可用

**解决方案**：
- 这是正常情况，客户端报告仍然包含完整的客户端统计信息
- 如需服务器统计，确保服务器端启用了 `ServerMonitor`

