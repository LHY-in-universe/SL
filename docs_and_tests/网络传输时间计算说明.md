# 网络传输时间计算说明

## 当前实现

在 `grpc_client.py` 的 `compute()` 方法中，时间测量如下：

```python
# 1. 编码输入张量（本地）
input_data, input_shape = self.codec.encode(input_tensor)

# 2. RPC 调用（测量网络传输+服务器计算）
start_time = time.time()
response = self.stub.Compute(request, timeout=self.timeout)
network_time = (time.time() - start_time) * 1000  # ms

# 3. 解码输出张量（本地）
output_tensor = self.codec.decode(data=response.data, shape=tuple(response.shape))
```

## 时间分解

### 1. `network_time`（在 grpc_client 中）
- **测量范围**：从 `stub.Compute()` 开始到返回响应的总时间
- **包含内容**：
  - 网络传输时间（发送请求数据）
  - 服务器处理时间（Trunk模型计算）
  - 网络传输时间（接收响应数据）

### 2. `response.compute_time_ms`（从服务器返回）
- **测量范围**：服务器端Trunk模型的计算时间
- **不包含**：网络传输时间、编码/解码时间

### 3. 真正的网络传输时间
```
网络传输时间 ≈ network_time - response.compute_time_ms
```

### 4. 在 `interactive_client.py` 中测量的 `trunk_time`
- **测量范围**：从调用 `trunk_client.compute()` 开始到返回的总时间
- **包含内容**：
  - 客户端编码时间（tensor → bytes）
  - 网络传输时间（发送）
  - 服务器计算时间（Trunk模型）
  - 网络传输时间（接收）
  - 客户端解码时间（bytes → tensor）

## 时间关系

```
trunk_time (interactive_client中)
  = encode_time + network_time (grpc_client中) + decode_time
  = encode_time + (网络传输 + 服务器计算 + 网络传输) + decode_time
  = encode_time + 网络传输时间 + response.compute_time_ms + 网络传输时间 + decode_time
```

## 注意事项

1. **编码/解码时间**：通常很短（< 1ms），但包含在 `trunk_time` 中
2. **网络传输时间**：包括发送和接收两部分，无法单独测量
3. **服务器计算时间**：从 `response.compute_time_ms` 获取，这是服务器端测量的

## 改进建议

如果需要更精确的时间分解，可以：
1. 在 `grpc_client.compute()` 中分别测量编码、解码时间
2. 返回详细的时间信息（编码时间、网络时间、服务器计算时间、解码时间）
3. 在客户端中显示这些详细信息

