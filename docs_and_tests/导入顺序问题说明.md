# 为什么出现 mutex 警告？导入顺序问题详解

## 问题描述

运行 `test_simple_load.py` 时出现 mutex 警告：
```
[mutex.cc : 452] RAW: Lock blocking 0x145bdfb18   @
```

但运行 `test_splitlearn_core_only.py` 时没有这个警告。

---

## 根本原因：环境变量设置的时机

### ❌ 错误的顺序 (test_simple_load.py)

```python
# 文件：test_simple_load.py

# 1. 导入标准库 (第 15-16 行)
import os
import sys

# 2. ❌ 导入 splitlearn_core (第 32 行)
#    ⚠️ 此时环境变量还没设置！
import splitlearn_core
    ↓
    导入 torch
    ↓
    PyTorch 初始化（使用默认多线程）
    ↓
    创建线程池
    ↓
    ❌ mutex 警告！

# 3. 设置环境变量 (第 60-65 行)
#    ❌ 太晚了！PyTorch 已经初始化完成
os.environ.setdefault('OMP_NUM_THREADS', '1')
os.environ.setdefault('MKL_NUM_THREADS', '1')
```

**问题**：
- `splitlearn_core` 内部导入了 `torch`
- PyTorch 在第一次导入时**立即初始化**
- 初始化时读取环境变量，决定使用几个线程
- 如果环境变量还没设置，PyTorch 使用默认值（多线程）
- 多线程模式下，PyTorch 创建线程池和互斥锁（mutex）
- 互斥锁初始化时产生警告

---

### ✅ 正确的顺序 (test_splitlearn_core_only.py)

```python
# 文件：test_splitlearn_core_only.py

# 1. 导入标准库 (第 14-16 行)
import os
import sys
import time

# 2. ✅ 先设置环境变量 (第 18-21 行)
#    ✅ 在导入任何模块之前！
os.environ.setdefault('OMP_NUM_THREADS', '1')
os.environ.setdefault('MKL_NUM_THREADS', '1')
os.environ.setdefault('NUMEXPR_NUM_THREADS', '1')

# 3. 然后导入 splitlearn_core (第 23 行)
from splitlearn_core import ModelFactory
    ↓
    导入 torch
    ↓
    PyTorch 初始化（读取环境变量）
    ↓
    ✅ 使用单线程模式
    ↓
    ✅ 没有 mutex 警告！
```

**正确**：
- 环境变量在**任何导入之前**就设置好
- PyTorch 初始化时读取到 `OMP_NUM_THREADS=1`
- 使用单线程模式，不创建线程池
- 没有多线程竞争，没有 mutex 警告

---

## 详细的执行流程对比

### ❌ 错误流程

```
时间线    test_simple_load.py                    PyTorch 状态
───────────────────────────────────────────────────────────────
T0       import os, sys                         未初始化

T1       import splitlearn_core                 开始初始化
         ↓                                       ↓
         内部: import torch                      检查环境变量
                                                 OMP_NUM_THREADS = (未设置)
                                                 ↓
                                                 使用默认值 (多线程)
                                                 ↓
                                                 创建线程池
                                                 ↓
                                                 初始化 mutex 锁
                                                 ↓
T2                                               ❌ mutex 警告！

T3       os.environ['OMP_NUM_THREADS'] = '1'    已经太晚！
         (环境变量设置)                          PyTorch 已初始化完成
```

---

### ✅ 正确流程

```
时间线    test_splitlearn_core_only.py           PyTorch 状态
───────────────────────────────────────────────────────────────
T0       import os, sys                         未初始化

T1       os.environ['OMP_NUM_THREADS'] = '1'    未初始化
         os.environ['MKL_NUM_THREADS'] = '1'    (环境变量已设置)

T2       from splitlearn_core import ...        开始初始化
         ↓                                       ↓
         内部: import torch                      检查环境变量
                                                 OMP_NUM_THREADS = '1' ✅
                                                 ↓
                                                 使用单线程模式
                                                 ↓
                                                 不创建线程池
                                                 ↓
T3                                               ✅ 初始化完成，没有警告！
```

---

## 为什么环境变量必须在导入之前设置？

### PyTorch 初始化过程

```cpp
// PyTorch C++ 代码伪代码

void initialize_pytorch() {
    // 第一次导入 torch 时执行

    // 1. 读取环境变量
    int num_threads = get_env_int("OMP_NUM_THREADS", DEFAULT_THREADS);

    // 2. 根据环境变量配置
    if (num_threads > 1) {
        // 多线程模式
        create_thread_pool(num_threads);
        init_mutex_locks();  // ← 这里产生警告！
    } else {
        // 单线程模式
        // 不创建线程池，不需要 mutex
    }

    // 3. 标记为已初始化
    pytorch_initialized = true;
}
```

**关键点**：
- 环境变量只在**初始化时**读取一次
- 初始化后再修改环境变量**无效**
- 一旦创建了线程池，就无法撤销

---

## 解决方案

### 标准模板（所有脚本都应该遵循）

```python
#!/usr/bin/env python3
"""
任何使用 SplitLearnCore 的脚本
"""

# 步骤 1: 导入基本库
import os
import sys

# 步骤 2: ✅ 立即设置环境变量（在导入任何其他模块之前！）
os.environ.setdefault('OMP_NUM_THREADS', '1')
os.environ.setdefault('MKL_NUM_THREADS', '1')
os.environ.setdefault('NUMEXPR_NUM_THREADS', '1')

# 步骤 3: 现在可以安全地导入其他模块
from splitlearn_core import ModelFactory
import torch
from transformers import AutoTokenizer

# 其余代码...
```

---

## 常见错误模式

### ❌ 错误模式 1：先导入再设置

```python
import torch  # ❌ 错误！PyTorch 在这里初始化

os.environ['OMP_NUM_THREADS'] = '1'  # 太晚了
```

### ❌ 错误模式 2：在函数中设置

```python
def main():
    os.environ['OMP_NUM_THREADS'] = '1'  # ❌ 错误！
    from splitlearn_core import ModelFactory  # 如果模块已导入，这里不会重新初始化
```

### ❌ 错误模式 3：在条件块中设置

```python
if __name__ == "__main__":
    os.environ['OMP_NUM_THREADS'] = '1'  # ❌ 可能太晚
    import torch
```

### ✅ 正确模式：模块级别立即设置

```python
import os
import sys

# ✅ 在模块顶层，导入语句之前
os.environ.setdefault('OMP_NUM_THREADS', '1')
os.environ.setdefault('MKL_NUM_THREADS', '1')

from splitlearn_core import ModelFactory
```

---

## 修复你的脚本

### 原始版本 (test_simple_load.py)

```python
# 第 15-16 行
import os
import sys

# 第 32 行 - ❌ 问题所在！
import splitlearn_core

# 第 60-65 行 - 太晚了
os.environ.setdefault('OMP_NUM_THREADS', '1')
```

### 修复版本 (test_simple_load_fixed.py) ✅

```python
# 第 11-12 行
import os
import sys

# 第 14-19 行 - ✅ 立即设置
os.environ.setdefault('OMP_NUM_THREADS', '1')
os.environ.setdefault('MKL_NUM_THREADS', '1')
os.environ.setdefault('NUMEXPR_NUM_THREADS', '1')

# 第 33 行 - 现在安全了
import splitlearn_core
```

---

## 验证修复

运行修复后的脚本：

```bash
python testcode/test_simple_load_fixed.py
```

**预期输出**：
```
[0/10] 设置环境变量（必须在导入任何模块之前！）
   ✓ OMP_NUM_THREADS = 1
   ✓ MKL_NUM_THREADS = 1
   ✓ NUMEXPR_NUM_THREADS = 1

[1/10] 添加 SplitLearnCore 路径...
   ✓ 路径已添加: ...

[2/10] 导入 splitlearn_core（环境变量已设置，不会有 mutex 警告）...
   [2.1] 导入 splitlearn_core...
   ✓ splitlearn_core 导入成功
   ...
```

**没有 mutex 警告！** ✅

---

## 总结

| 方面 | 错误做法 | 正确做法 |
|------|---------|---------|
| **顺序** | 先导入，后设置环境变量 | 先设置环境变量，后导入 |
| **位置** | 在函数或条件块中设置 | 在模块顶层立即设置 |
| **时机** | PyTorch 初始化后设置 | PyTorch 初始化前设置 |
| **结果** | ❌ mutex 警告 | ✅ 无警告 |

**黄金规则**：
```
环境变量必须在 import torch (或任何会导入 torch 的模块) 之前设置！
```

---

## 参考

- `test_splitlearn_core_only.py` - 正确示例
- `test_simple_load_fixed.py` - 修复后的版本
- `test_pytorch_init.py` - 关于 PyTorch 初始化的详细说明
