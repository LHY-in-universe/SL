# 监控功能说明

## 功能概述

交互式 GPT-2 脚本现在支持完整的运行时监控，包括：

1. **每个 Token 生成时间统计** - 精确到每个生成的 token
2. **编码/解码时间统计** - 输入编码和输出解码时间
3. **交互级别统计** - 每次交互的总体时间
4. **会话级别统计** - 整个会话的汇总统计

## 监控组件

### 1. TokenMonitor（本地实现）

如果 SplitLearnMonitor 不可用，会自动使用本地实现的 `TokenMonitor`：

- **位置**: `gpt2_interactive/token_monitor.py`
- **功能**:
  - 记录每个 token 的生成时间
  - 记录编码/解码时间
  - 提供统计摘要
  - 支持导出 JSON/TXT 报告

### 2. SplitLearnMonitor（如果可用）

如果 SplitLearnMonitor 包可用，会同时使用：

- **位置**: `SplitLearnMonitor/src/splitlearn_monitor/`
- **功能**:
  - 系统资源监控（CPU、内存）
  - 性能追踪
  - HTML 报告生成

## 监控数据

### 每个 Token 的监控数据

```python
{
    'step': 1,                    # 第几个 token
    'token_id': 12345,            # Token ID
    'token_text': 'hello',        # Token 文本
    'generation_time_ms': 25.3,   # 生成时间（毫秒）
    'timestamp': 1234567890.123,  # 时间戳
    'metadata': {...}             # 元数据（可选）
}
```

### 每次交互的监控数据

```python
{
    'interaction_id': 1,
    'user_input': 'hello',
    'tokens': [...],              # 所有 token 的详细信息
    'total_tokens': 10,
    'total_time_ms': 250.5,
    'encode_time_ms': 0.5,
    'decode_time_ms': 1.2,
    'response': 'hello world...'
}
```

## 统计信息

监控器会提供以下统计信息：

### Token 生成时间统计
- 平均时间
- 中位数
- 最小值/最大值
- P50, P95, P99 百分位

### 交互时间统计
- 平均交互时间
- 总交互次数
- 平均每次交互的 token 数

### 编码/解码时间统计
- 平均编码时间
- 平均解码时间

## 输出示例

运行时会显示：

```
[交互 #1 时间统计:]
  编码时间: 0.50 ms
  模型推理时间: 245.30 ms ⭐
  解码时间: 1.20 ms
  总处理时间: 247.00 ms
  生成 Token 数: 10
  平均每个 Token 时间: 24.53 ms
  每个 Token 时间: ['25.1', '24.8', '24.5', '24.3', '24.2', '24.1', '24.0', '23.9', '23.8', '23.7'] ms
```

会话结束时会显示：

```
============================================================
监控统计摘要
============================================================
会话名称: gpt2_interactive_20241207_120000
总交互次数: 5
总生成 Token 数: 50
平均每次交互 Token 数: 10.0

每个 Token 生成时间统计 (ms):
  平均: 24.53 ms
  中位数: 24.50 ms
  最小: 23.70 ms
  最大: 25.10 ms
  P95: 25.05 ms
  P99: 25.08 ms
...
```

## 报告文件

### JSON 报告

包含完整的监控数据：
- 所有交互的详细信息
- 每个 token 的生成时间
- 统计摘要

### TXT 报告

人类可读的文本格式：
- 交互摘要
- Token 详情列表

## 使用方法

监控功能已自动集成，无需额外配置：

```bash
./run.sh
```

监控数据会在：
1. 运行时实时显示
2. 会话结束时显示统计摘要
3. 自动保存为 JSON 报告文件

## 自定义监控

如果需要自定义监控行为，可以修改：

1. **TokenMonitor 类** (`token_monitor.py`)
   - 添加更多统计指标
   - 修改报告格式

2. **监控集成** (`interactive_gpt2_splitlearn.py`)
   - 调整监控粒度
   - 添加自定义元数据

## 注意事项

1. 监控会略微增加开销（主要是时间记录）
2. 报告文件会保存在当前目录
3. 如果 SplitLearnMonitor 不可用，会自动使用本地 TokenMonitor
